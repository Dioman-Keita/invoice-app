openapi: 3.0.3
info:
  title: CMDT Invoice API
  version: 2.0.0
  description: |
    API de gestion de factures avec authentification JWT via cookie HttpOnly.
    
    ## Rôles disponibles
    - `admin` : Accès complet à toutes les fonctionnalités
    - `invoice_manager` : Gestion des factures et fournisseurs
    - `dfc_agent` : Gestion des factures DFC

servers:
  - url: http://localhost:3000/api
    description: Développement local

# Configuration de sécurité globale (surchargeable au niveau des opérations)
security:
  - cookieAuth: []

components:
  # Schémas de sécurité
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: JWT stocké dans un cookie HttpOnly

  # Schémas de données
  schemas:
    ErrorResponse:
      type: object
      properties:
        success: 
          type: boolean
          example: false
        message:
          type: string
          example: "Une erreur s'est produite"
        errors:
          type: array
          items:
            type: string
          example: ["Le champ email est requis"]
      required: [success, message]

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          example: "user@example.com"
        firstName:
          type: string
          example: "Jean"
        lastName:
          type: string
          example: "Dupont"
        role:
          type: string
          enum: [admin, invoice_manager, dfc_agent]
          example: "invoice_manager"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, email, firstName, lastName, role]

    # Schémas de requête
    RegisterRequest:
      type: object
      properties:
        email: 
          type: string 
          format: email
          example: "user@example.com"
        password: 
          type: string 
          format: password
          minLength: 8
          example: "MotDePasse123!"
        firstName: 
          type: string
          minLength: 2
          example: "Jean"
        lastName: 
          type: string
          minLength: 2
          example: "Dupont"
        role: 
          type: string 
          enum: [admin, invoice_manager, dfc_agent]
          example: "invoice_manager"
        terms: 
          type: boolean
          example: true
      required: [email, password, firstName, lastName, role, terms]
      additionalProperties: false

    LoginRequest:
      type: object
      properties:
        email: 
          type: string 
          format: email
          example: "user@example.com"
        password: 
          type: string 
          format: password
          example: "MotDePasse123!"
        rememberMe:
          type: boolean
          example: true
      required: [email, password]
      additionalProperties: false

    # Schémas de réponses
    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: JWT d'authentification (également envoyé en cookie)
      required: [success, user]

    AuthStatusResponse:
      type: object
      properties:
        isAuthenticated: 
          type: boolean
          example: true
        user: 
          $ref: '#/components/schemas/User'

    # Schémas pour les factures
    Invoice:
      type: object
      properties:
        id:
          type: string
          format: uuid
        number:
          type: string
        amount:
          type: number
          format: float
        status:
          type: string
          enum: [draft, pending, approved, rejected, paid]
        supplierId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, number, amount, status, supplierId]

    # Schémas pour les fournisseurs
    Supplier:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        address:
          type: string
        taxId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, email]
paths:
  /health:
    get:
      summary: Health check
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
                  message: { type: string }
  /protected:
    get:
      summary: Test d'authentification
      responses:
        '200':
          description: Utilisateur courant
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
        '401':
          description: Non authentifié
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
  /auth/register:
    post:
      summary: Inscription utilisateur
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      responses:
        '200': { description: Email de vérification envoyé }
        '400': { description: Requête invalide, email/terms
          }
  /auth/login:
    post:
      summary: Connexion
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        '200':
          description: Connecté (cookie auth_token défini)
          headers:
            Set-Cookie:
              schema: { type: string }
              description: Cookie HttpOnly auth_token
        '401':
          description: Identifiants invalides
  /auth/status:
    get:
      summary: Statut d'authentification
      responses:
        '200':
          description: Statut
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthStatusResponse' }
        '401': { description: Non authentifié }
  /auth/profile:
    get:
      summary: Profil utilisateur
      responses:
        '200':
          description: Profil
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Non authentifié }
  /auth/forgot-password:
    post:
      summary: Demande de réinitialisation de mot de passe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
              required: [email]
      responses:
        '200': { description: Email envoyé }
  /auth/reset-password:
    post:
      summary: Réinitialisation du mot de passe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token: { type: string }
                newPassword: { type: string }
              required: [token, newPassword]
      responses:
        '200': { description: Mot de passe mis à jour }
  /auth/logout:
    post:
      summary: Déconnexion
      responses:
        '200': { description: Déconnecté, cookie supprimé }
  /auth/silent-refresh:
    post:
      summary: Rafraîchissement silencieux
      responses:
        '200': { description: Token rafraîchi si valide }
        '401': { description: Non authentifié }
  /auth/token:
    get:
      summary: Récupérer le token courant
      responses:
        '200':
          description: Token courant
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
                  payload: { type: object }
  /auth/admin/create-user:
    post:
      summary: Création d'utilisateur (admin)
      responses:
        '201': { description: Créé }
        '403': { description: Accès refusé }
  /invoices/last-num:
    get:
      summary: Dernier numéro de facture enregistré
      responses:
        '200':
          description: Dernier numéro
          content:
            application/json:
              schema:
                type: object
                properties:
                  lastInvoiceNumber: { type: string }
  /invoices/next-num:
    get:
      summary: Prochain numéro de facture attendu
      responses:
        '200':
          description: Prochain numéro
          content:
            application/json:
              schema:
                type: object
                properties:
                  nextInvoiceNumber: { type: string }
  /invoices:
    get:
      summary: Lister les factures (filtrage par rôle)
      responses:
        '200':
          description: Liste de factures
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Invoice' }
    post:
      summary: Créer une facture
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateInvoiceRequest' }
      responses:
        '201':
          description: Facture créée
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Invoice' }
  /invoices/{id}:
    get:
      summary: Détail d'une facture
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Facture
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Invoice' }
        '403': { description: Accès refusé }
        '404': { description: Introuvable }
  /invoices/update/{id}:
    post:
      summary: Mettre à jour une facture
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200': { description: Mis à jour }
        '403': { description: Accès refusé }
        '404': { description: Introuvable }
  /invoices/delete/{id}:
    post:
      summary: Supprimer une facture
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: Supprimé }
        '403': { description: Accès refusé }
        '404': { description: Introuvable }
  /supplier:
    get:
      summary: Lister les fournisseurs
      responses:
        '200':
          description: Liste de fournisseurs
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Supplier' }
    post:
      summary: Créer un fournisseur
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '201': { description: Créé }
  /supplier/delete/{id}:
    post:
      summary: Supprimer un fournisseur
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: Supprimé }
  /supplier/phone:
    get:
      summary: Rechercher un fournisseur par téléphone
      parameters:
        - in: query
          name: phone
          schema: { type: string }
      responses:
        '200':
          description: Résultats
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Supplier' }
  /supplier/{id}:
    get:
      summary: Détail fournisseur
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Fournisseur
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Supplier' }
  /suppliers/search:
    get:
      summary: Recherche par champ
      parameters:
        - in: query
          name: field
          schema: { type: string }
        - in: query
          name: value
          schema: { type: string }
      responses:
        '200':
          description: Résultats
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Supplier' }
  /suppliers/find:
    get:
      summary: Recherche multi-champs
      parameters:
        - in: query
          name: name
          schema: { type: string, nullable: true }
        - in: query
          name: account_number
          schema: { type: string, nullable: true }
        - in: query
          name: phone
          schema: { type: string, nullable: true }
      responses:
        '200':
          description: Résultats
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Supplier' }
  /suppliers/verify-conflicts:
    get:
      summary: Vérifier les conflits fournisseur
      parameters:
        - in: query
          name: account_number
          schema: { type: string }
        - in: query
          name: phone
          schema: { type: string }
      responses:
        '200':
          description: Résultat de vérification
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
  /settings/fiscal:
    get:
      summary: Informations fiscales et configuration courante
      responses:
        '200':
          description: Paramètres fiscaux
          content:
            application/json:
              schema:
                type: object
                properties:
                  fiscalYear: { type: string }
                  app_version: { type: string }
                  cmdt_format:
                    type: object
                    properties:
                      padding: { type: integer }
                      max: { type: integer }
                  auto_year_switch: { type: boolean }
                  year_end_warning_threshold: { type: integer }
                  counter:
                    type: object
                    properties:
                      fiscal_year: { type: string }
                      last_cmdt_number: { type: integer }
                      remaining: { type: integer }
                      max: { type: integer }
                  availableYears:
                    type: array
                    items:
                      type: object
                      properties:
                        year:
                          type: array
                          items: { type: string }
                        isCurrent: { type: boolean }
                        canActivate: { type: boolean }
                  warningInfo:
                    type: object
  /settings/auto-year-switch:
    post:
      summary: Activer/Désactiver l'auto-switch d'année fiscale
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                enable: { type: boolean }
              required: [enable]
      responses:
        '200':
          description: Mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  auto_year_switch: { type: boolean }
        '403': { description: Accès refusé }
  /settings/fiscal-year/switch:
    post:
      summary: Bascule manuelle de l'année fiscale
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                newYear: { type: string }
              required: [newYear]
      responses:
        '200': { description: Année fiscale changée }
        '400': { description: Requête invalide ou auto-switch activé }
        '403': { description: Accès refusé }

  /invoices/dfc/pending:
    get:
      summary: Lister les factures DFC en attente pour l'année fiscale courante
      responses:
        '200':
          description: Liste des factures DFC en attente
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Invoice' }

  /invoices/{id}/dfc/approve:
    post:
      summary: Approuver une facture DFC
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: Facture approuvée }
        '404': { description: Introuvable }

  /invoices/{id}/dfc/reject:
    post:
      summary: Rejeter une facture DFC
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                comments: { type: string }
      responses:
        '200': { description: Facture rejetée }
        '404': { description: Introuvable }

  /search/invoices:
    get:
      summary: Recherche avancée de factures
      responses:
        '200':
          description: Résultats
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Invoice' }

  /search/suppliers:
    get:
      summary: Recherche avancée de fournisseurs
      responses:
        '200':
          description: Résultats
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Supplier' }

  /search/relational:
    get:
      summary: Recherche relationnelle (factures/fournisseurs)
      responses:
        '200': { description: Résultats relationnels }

  /export/history:
    get:
      summary: Historique des exports
      responses:
        '200': { description: Historique }

  /export/advanced:
    get:
      summary: Export avancé selon filtres
      responses:
        '200': { description: Export généré }

  /fiscal-years:
    get:
      summary: Années fiscales disponibles
      responses:
        '200':
          description: Liste des années fiscales
          content:
            application/json:
              schema:
                type: array
                items: { type: string }
