openapi: 3.0.3
info:
  title: CMDT Invoice API
  version: 2.0.0
  description: |
    Invoice Management API with JWT Authentication via HttpOnly cookie.
    
    ## Available Roles
    - `admin`: Full access to all features
    - `invoice_manager`: Invoice and supplier management
    - `dfc_agent`: DFC invoice management

servers:
  - url: http://localhost:3000/api
    description: Local Development

# Global Security Configuration
security:
  - cookieAuth: []

components:
  # Security Schemes
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: JWT stored in an HttpOnly cookie

  # Data Schemas
  schemas:
    ErrorResponse:
      type: object
      properties:
        success: 
          type: boolean
          example: false
        message:
          type: string
          example: "An error occurred"
        errors:
          type: array
          items:
            type: string
          example: ["Email is required"]
      required: [success, message]

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          example: "user@example.com"
        firstName:
          type: string
          example: "Jean"
        lastName:
          type: string
          example: "Dupont"
        role:
          type: string
          enum: [admin, invoice_manager, dfc_agent]
          example: "invoice_manager"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, email, firstName, lastName, role]

    # Request Schemas
    RegisterRequest:
      type: object
      properties:
        email: 
          type: string 
          format: email
          example: "user@example.com"
        password: 
          type: string 
          format: password
          minLength: 8
          example: "Password123!"
        firstName: 
          type: string
          minLength: 2
          example: "Jean"
        lastName: 
          type: string
          minLength: 2
          example: "Dupont"
        role: 
          type: string 
          enum: [admin, invoice_manager, dfc_agent]
          example: "invoice_manager"
        terms: 
          type: boolean
          example: true
      required: [email, password, firstName, lastName, role, terms]
      additionalProperties: false

    LoginRequest:
      type: object
      properties:
        email: 
          type: string 
          format: email
          example: "user@example.com"
        password: 
          type: string 
          format: password
          example: "Password123!"
        rememberMe:
          type: boolean
          example: true
      required: [email, password]
      additionalProperties: false

    # Response Schemas
    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: Authentication JWT (also sent as cookie)
      required: [success, user]

    AuthStatusResponse:
      type: object
      properties:
        isAuthenticated: 
          type: boolean
          example: true
        user: 
          $ref: '#/components/schemas/User'

    # Invoice Schemas
    Invoice:
      type: object
      properties:
        id:
          type: string
          format: uuid
        number:
          type: string
        amount:
          type: number
          format: float
        status:
          type: string
          enum: [draft, pending, approved, rejected, paid]
        supplierId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, number, amount, status, supplierId]

    # Supplier Schemas
    Supplier:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          format: email
        phone:
          type: string
        address:
          type: string
        taxId:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, email]

    ExportRequest:
      type: object
      properties:
        type:
          type: string
          enum: [invoice, supplier, relational]
        variant:
          type: string
          enum: [list, overview]
        format:
          type: string
          enum: [pdf, odt, xlsx]
        search:
          type: object
          additionalProperties: true
      required: [type, variant, format]

    # Stats Schemas
    DashboardKPIs:
      type: object
      properties:
        total_employee: { type: integer }
        total_invoices: { type: integer }
        business_amount: { type: number }
        total_invoice_pending: { type: integer }
        dateFrom: { type: string, format: date }
        dateTo: { type: string, format: date }

    InvoiceEvolution:
      type: object
      properties:
        labels: 
          type: array
          items: { type: string }
        datasets:
          type: array
          items: 
            type: object
            additionalProperties: true

paths:
  /health:
    get:
      summary: Health check
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
                  message: { type: string }
  /auth/register:
    post:
      summary: User registration
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      responses:
        '200': { description: Verification email sent }
        '400': { description: Invalid request }
  /auth/login:
    post:
      summary: Login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        '200':
          description: Logged in (auth_token cookie set)
          headers:
            Set-Cookie:
              schema: { type: string }
              description: HttpOnly auth_token cookie
        '401':
          description: Invalid credentials
  /auth/status:
    get:
      summary: Authentication status
      responses:
        '200':
          description: Status
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthStatusResponse' }
        '401': { description: Unauthenticated }
  /auth/profile:
    get:
      summary: User profile
      responses:
        '200':
          description: Profile
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '401': { description: Unauthenticated }
  /auth/logout:
    post:
      summary: Logout
      responses:
        '200': { description: Logged out, cookie removed }
  /invoices:
    get:
      summary: List invoices (filtered by role)
      responses:
        '200':
          description: List of invoices
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Invoice' }
    post:
      summary: Create an invoice
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Invoice' }
      responses:
        '201':
          description: Invoice created
  /invoices/last-num:
    get:
      summary: Get last registered invoice number
      responses:
        '200':
          description: Last number
          content:
            application/json:
              schema:
                type: object
                properties:
                  lastInvoiceNumber: { type: string }
  /invoices/next-num:
    get:
      summary: Get next expected invoice number
      responses:
        '200':
          description: Next number
          content:
            application/json:
              schema:
                type: object
                properties:
                  nextInvoiceNumber: { type: string }
  /invoices/dfc/pending:
    get:
      summary: List pending DFC invoices (current fiscal year)
      responses:
        '200':
          description: List of pending invoices
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Invoice' }
  /users:
    get:
      summary: List all users (Admin only)
      responses:
        '200':
          description: Array of users
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/User' }
        '403': { description: Access denied }
  /users/{id}:
    get:
      summary: Get user details (Admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/User' }
        '403': { description: Access denied }
        '404': { description: User not found }
    put:
      summary: Update user (Admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/User' }
      responses:
        '200': { description: User updated }
        '403': { description: Access denied }
    delete:
      summary: Delete user (Admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { description: User deleted }
        '403': { description: Access denied }
  /users/{id}/disable:
    post:
      summary: Disable user account (Admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { description: User disabled }
        '403': { description: Access denied }
  /users/{id}/enable:
    post:
      summary: Enable user account (Admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { description: User enabled }
        '403': { description: Access denied }
  /system/logs:
    get:
      summary: Get system error logs (Admin only)
      parameters:
        - name: level
          in: query
          schema: { type: string, enum: [error, warn, info] }
        - name: page
          in: query
          schema: { type: integer }
        - name: limit
          in: query
          schema: { type: integer }
      responses:
        '200':
          description: Paginated error logs
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs: { type: array }
                  total: { type: integer }
        '403': { description: Access denied }
    delete:
      summary: Clear all system logs (Admin only)
      responses:
        '200': { description: Logs cleared }
        '403': { description: Access denied }
  /migration/request:
    post:
      summary: Submit role migration request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                targetRole: { type: string }
                motivation: { type: string }
      responses:
        '200': { description: Request submitted }
        '400': { description: Invalid request }
  /migration/requests:
    get:
      summary: List all migration requests (Admin only)
      responses:
        '200':
          description: Array of migration requests
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
        '403': { description: Access denied }
  /migration/my-requests:
    get:
      summary: Get current user's migration requests
      responses:
        '200':
          description: User's requests
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
  /migration/{id}/approve:
    post:
      summary: Approve migration request (Admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200': { description: Request approved }
        '403': { description: Access denied }
  /migration/{id}/reject:
    post:
      summary: Reject migration request (Admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reviewNote: { type: string }
      responses:
        '200': { description: Request rejected }
        '403': { description: Access denied }
  /migration/stats:
    get:
      summary: Get migration statistics (Admin only)
      responses:
        '200':
          description: Migration statistics
          content:
            application/json:
              schema:
                type: object
        '403': { description: Access denied }
  /stats/dashboard/kpis:
    get:
      summary: Dashboard KPIs (Admin)
      responses:
        '200':
          description: Key Performance Indicators
          content:
            application/json:
              schema: { $ref: '#/components/schemas/DashboardKPIs' }
        '403': { description: Access denied }
  /stats/invoices/evolution:
    get:
      summary: Invoice Evolution Stats (Admin)
      responses:
        '200':
          description: Evolution data for charts
          content:
            application/json:
              schema: { $ref: '#/components/schemas/InvoiceEvolution' }
        '403': { description: Access denied }
